<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wavekey OS</title>
    
    <!-- MANIFEST -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --bg: #050505; --surface: #121212; --primary: #2563eb; --accent: #3b82f6; --text: #fff; --border: rgba(255,255,255,0.08); }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); height: 100dvh; overflow: hidden; display: flex; flex-direction: column; user-select: none; }
        
        /* LAYOUT */
        #app-container { flex: 1; overflow-y: auto; padding-bottom: 100px; }
        .view { display: none; padding: 20px; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .view.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS */
        .glass-card { background: #111; border: 1px solid var(--border); border-radius: 24px; padding: 24px; margin-bottom: 16px; position: relative; overflow: hidden; }
        .glass-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--primary), transparent); opacity: 0.5; }
        .action-card { background: linear-gradient(135deg, #2563eb, #1d4ed8); border: none; padding: 24px; border-radius: 24px; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(37, 99, 235, 0.2); cursor: pointer; transition: transform 0.1s; position: relative; overflow: hidden; }
        .action-card:active { transform: scale(0.96); }
        
        /* AUTH STATUS */
        .auth-badge { font-size: 10px; background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 4px 8px; border-radius: 12px; display: flex; align-items: center; gap: 6px; border: 1px solid rgba(34, 197, 94, 0.2); }
        .dot-pulse { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 8px #22c55e; animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* INTERCEPTORS */
        #nfc-intercept { position: fixed; inset: 0; z-index: 300; background: #2563eb; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 40px; cursor: pointer; transition: background 0.3s; }
        #nfc-intercept.success { background: #111; cursor: default; }
        .launcher-grid { display: none; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; margin-top: 30px; }
        #nfc-intercept.success .launcher-grid { display: grid; }
        .launch-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 20px; border-radius: 16px; font-weight: 700; display: flex; flex-direction: column; align-items: center; gap: 10px; transition: 0.2s; }
        
        /* WIZARD GRID */
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; max-height: 55vh; overflow-y: auto; padding-bottom: 20px; }
        .option-card { background: #1a1a1a; border: 1px solid var(--border); padding: 16px; border-radius: 16px; text-align: center; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100px; position: relative; }
        .option-card.selected { border-color: var(--accent); background: rgba(59,130,246,0.15); color: white; }
        .check-badge { position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; background: var(--primary); border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 10px; color: white; }
        .option-card.selected .check-badge { display: flex; }
        .option-icon { font-size: 24px; margin-bottom: 10px; opacity: 0.8; }
        .option-title { font-weight: 700; font-size: 13px; margin-bottom: 4px; }
        .option-desc { font-size: 10px; color: #777; line-height: 1.2; }

        /* COPY OVERLAY */
        #copy-overlay { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #22c55e; color: black; padding: 12px 24px; border-radius: 30px; font-weight: 800; font-size: 14px; z-index: 200; transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1); box-shadow: 0 10px 30px rgba(34, 197, 94, 0.4); pointer-events: none; display: flex; align-items: center; gap: 8px; }
        #copy-overlay.show { transform: translateX(-50%) translateY(0); }

        /* NAV */
        .nav-island { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px; background: rgba(20,20,20,0.9); backdrop-filter: blur(16px); border: 1px solid var(--border); border-radius: 40px; display: flex; justify-content: space-evenly; align-items: center; z-index: 50; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        .nav-btn { font-size: 22px; color: #444; padding: 12px; border-radius: 50%; transition: 0.3s; }
        .nav-btn.active { color: var(--accent); background: rgba(59,130,246,0.1); transform: translateY(-3px); }
        
        /* BUTTONS */
        .btn-main { background: var(--primary); color: white; padding: 16px; border-radius: 16px; font-weight: 700; width: 100%; text-align: center; }
        .btn-sec { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #ccc; padding: 12px; border-radius: 12px; font-weight: 600; width: 100%; }
        .gardener-input { background: #0a0a0a; border: 1px dashed #333; width: 100%; height: 150px; border-radius: 12px; padding: 15px; color: #fff; font-family: monospace; font-size: 12px; resize: none; outline: none; }
    </style>
</head>
<body>

    <!-- LOGIN GATE -->
    <div id="login-gate" class="fixed inset-0 bg-black z-[200] flex flex-col items-center justify-center p-8" style="display:none;">
        <div class="text-5xl text-blue-600 mb-4"><i class="fa-solid fa-fingerprint"></i></div>
        <h1 class="text-4xl font-bold mb-2 text-white">Wavekey</h1>
        <p class="text-gray-500 text-sm mb-8">Identity Operating System</p>
        <button onclick="app.login()" class="bg-white text-black px-8 py-4 rounded-full font-bold flex items-center gap-3 hover:bg-gray-200 transition">
            <i class="fa-brands fa-google"></i> Initialize System
        </button>
    </div>

    <!-- INTERCEPTORS -->
    <div id="nfc-intercept" onclick="app.executeNfcCopy()">
        <i id="nfc-icon" class="fa-solid fa-fingerprint text-6xl text-white mb-6"></i>
        <h1 id="nfc-title" class="text-3xl font-black text-white mb-2">WAVEKEY DETECTED</h1>
        <p id="nfc-desc" class="text-blue-100 text-sm">Tap anywhere to inject identity.</p>
        <div id="launcher-grid" class="launcher-grid" onclick="event.stopPropagation()"></div>
        <button id="close-intercept" class="mt-8 text-gray-500 text-sm underline hidden" onclick="event.stopPropagation(); app.closeIntercept()">Dismiss</button>
    </div>
    <div id="copy-overlay"><i class="fa-solid fa-check"></i> WAVEKEY COPIED</div>

    <!-- APP -->
    <div id="app-container">
        <div id="view-dashboard" class="view active">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <div class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-1">Identity Engine</div>
                    <div class="text-3xl font-extrabold text-white mb-2">Wavekey <span class="text-blue-600">Pro</span></div>
                    <!-- AUTH INDICATOR -->
                    <div class="auth-badge">
                        <div class="dot-pulse"></div>
                        <span id="user-email">Authenticating...</span>
                    </div>
                </div>
                <div class="w-10 h-10 rounded-full bg-gray-900 border border-gray-800 flex items-center justify-center cursor-pointer" onclick="app.startWizard()"><i class="fa-solid fa-sliders text-gray-400"></i></div>
            </div>
            <div class="action-card" onclick="app.copyWavekey()">
                <div class="flex flex-col items-center justify-center h-full"><i class="fa-solid fa-fingerprint text-white/90"></i><div class="text-white font-black text-xl tracking-tight">COPY WAVEKEY</div><div class="text-blue-100 text-xs mt-2 opacity-80 text-center">Launch Identity</div></div>
            </div>
            <div class="glass-card">
                <div class="flex justify-between items-center mb-3"><div class="text-xs font-bold uppercase text-gray-500">Persistent Memory</div><div class="text-[10px] text-green-500">Synced</div></div>
                <textarea id="wk_memory" class="w-full bg-gray-900/50 rounded-xl p-3 text-sm text-gray-300 outline-none h-24 resize-none border border-gray-800 font-mono" placeholder="Memory buffer..."></textarea>
            </div>
            <div class="glass-card flex items-center justify-between">
                <div><h3 class="font-bold text-sm">Physical Anchor</h3><p class="text-gray-500 text-xs mt-1">Burn deep link to NFC.</p></div>
                <button onclick="app.writeNfc()" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-xs font-bold transition"><i class="fa-solid fa-wifi mr-1"></i> Burn</button>
            </div>
            <div id="nfc-status" class="text-center text-xs mt-2 text-gray-500 h-4"></div>
        </div>

        <!-- GARDENER -->
        <div id="view-gardener" class="view">
            <h2 class="text-2xl font-bold mb-2">The Gardener</h2>
            <p class="text-gray-400 text-xs mb-6">Paste chat logs here to auto-evolve your memory.</p>
            <div class="glass-card">
                <textarea id="gardener-input" class="w-full bg-[#0a0a0a] border border-dashed border-[#333] rounded-xl p-4 text-white font-mono text-xs h-[150px] resize-none outline-none focus:border-blue-500" placeholder="Paste chat transcript here..."></textarea>
                <button id="btn-process" onclick="app.runGardener()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl mt-4 transition flex items-center justify-center gap-2"><i class="fa-solid fa-wand-magic-sparkles"></i> Process & Evolve</button>
                <div id="gardener-status" class="text-xs text-center mt-3 text-gray-500 min-h-[20px]"></div>
            </div>
        </div>
        
        <!-- VAULT -->
        <div id="view-vault" class="view">
            <h2 class="text-2xl font-bold mb-6">Settings</h2>
            <div class="glass-card"><div class="text-xs font-bold uppercase text-gray-500 mb-2">Relay Configuration</div><input type="text" id="relay-url" class="w-full bg-transparent border-b border-gray-700 py-2 text-white outline-none focus:border-blue-500 transition" placeholder="https://..." oninput="app.saveKeys()"></div>
            <div class="p-4 bg-blue-900/20 border border-blue-800 rounded-xl text-xs text-blue-300"><i class="fa-solid fa-circle-info mr-2"></i> <strong>SaaS Mode Active:</strong> Processing handled by Wavekey Pro.</div>
            <button onclick="app.logout()" class="w-full mt-8 border border-red-900/50 text-red-500 py-3 rounded-xl text-sm font-bold">LOGOUT</button>
        </div>
    </div>

    <div id="wizard-overlay" class="fixed inset-0 bg-black z-50 hidden flex-col p-6">
        <div class="w-full h-1 bg-gray-900 rounded-full mb-8"><div id="wiz-progress" class="h-full bg-blue-500 rounded-full w-0 transition-all duration-300"></div></div>
        <div class="flex-1 flex flex-col"><h2 id="wiz-title" class="text-3xl font-bold mb-2 text-white"></h2><p id="wiz-desc" class="text-gray-400 text-sm mb-4"></p><div id="wiz-content" class="flex-1"></div></div>
        <div class="flex gap-4 mt-4"><button onclick="app.prevStep()" class="btn-sec">Back</button><button onclick="app.nextStep()" class="btn-main" id="btn-next">Next</button></div>
    </div>

    <div class="nav-island">
        <div onclick="app.nav('view-dashboard')" class="nav-btn active" id="nav-dashboard"><i class="fa-solid fa-fingerprint"></i></div>
        <div onclick="app.nav('view-gardener')" class="nav-btn" id="nav-gardener"><i class="fa-solid fa-seedling"></i></div>
        <div onclick="app.nav('view-vault')" class="nav-btn" id="nav-vault"><i class="fa-solid fa-gear"></i></div>
    </div>

    <script>
        const FIREBASE_CONFIG = { apiKey: "AIzaSyDmQ7QJYlakymhn30b24wzheW5x090TzGY", authDomain: "wavekey-hub.firebaseapp.com", projectId: "wavekey-hub", storageBucket: "wavekey-hub.firebasestorage.app", messagingSenderId: "604444820306", appId: "1:604444820306:web:7b0aef3d149075832e308b" };
        const LLM_URLS = { 'gpt': 'https://chatgpt.com/', 'claude': 'https://claude.ai/new', 'gemini': 'https://gemini.google.com/app', 'grok': 'https://x.com/i/grok', 'perplexity': 'https://www.perplexity.ai/', 'llama': 'https://www.meta.ai/', 'copilot': 'https://copilot.microsoft.com/', 'mistral': 'https://chat.mistral.ai/chat' };
        
        // WIZARD DATA
        const WIZARD_DATA = [
            { id: 'name', type: 'text', title: 'Identity', desc: 'What is your name?', placeholder: 'Justin' },
            { id: 'role', type: 'text', title: 'Expertise', desc: 'What is your primary domain?', placeholder: 'Cybersecurity / Founder' },
            {
                id: 'target_llm', type: 'select', title: 'Intelligence Fleet', desc: 'Select ALL AI models you use.', multi: true,
                options: [
                    {val: 'gpt', title: 'ChatGPT', icon: 'fa-bolt'},
                    {val: 'claude', title: 'Claude', icon: 'fa-brain'},
                    {val: 'gemini', title: 'Gemini', icon: 'fa-gem'},
                    {val: 'grok', title: 'Grok', icon: 'fa-rocket'},
                    {val: 'perplexity', title: 'Perplexity', icon: 'fa-globe'},
                    {val: 'llama', title: 'Llama', icon: 'fa-layer-group'},
                    {val: 'copilot', title: 'Copilot', icon: 'fa-plane'},
                    {val: 'mistral', title: 'Mistral', icon: 'fa-wind'}
                ]
            },
            {
                id: 'persona', type: 'select', title: 'Persona Archetype', desc: 'Choose your interface personality.',
                options: [
                    {val: 'Visionary', title: 'The Visionary', desc: 'Minimalist. Direct. Perfectionist.', icon: 'fa-glasses'},
                    {val: 'Stoic', title: 'The Stoic', desc: 'Calm. Logical.', icon: 'fa-stone'},
                    {val: 'Hacker', title: 'The Hacker', desc: 'Cyberpunk. Technical.', icon: 'fa-terminal'},
                    {val: 'Executive', title: 'The Executive', desc: 'Strategic. Brief.', icon: 'fa-briefcase'},
                    {val: 'Socratic', title: 'The Tutor', desc: 'Teaches by asking.', icon: 'fa-question'},
                    {val: 'ELI5', title: 'The Buddy', desc: 'Simple terms. Friendly.', icon: 'fa-child'},
                    {val: 'DrillSgt', title: 'The Commander', desc: 'Accountability. Action. No excuses.', icon: 'fa-person-military-rifle'},
                    {val: 'Mystic', title: 'The Oracle', desc: 'Abstract. Pattern-focused. Deep.', icon: 'fa-eye'},
                    {val: 'Researcher', title: 'The Analyst', desc: 'Data-driven. Cited sources. Thorough.', icon: 'fa-magnifying-glass'},
                    {val: 'Creative', title: 'The Artist', desc: 'Expressive. Divergent thinking. Colorful.', icon: 'fa-palette'}
                ]
            },
            {
                id: 'needs', type: 'select', title: 'Cognitive Filter', desc: 'Select ALL that apply.', multi: true,
                options: [
                    {val: 'Visual', title: 'Visual Learner', desc: 'Analogies, Diagrams.', icon: 'fa-image'},
                    {val: 'ADHD', title: 'ADHD Optimized', desc: 'Bullet points. Bold text.', icon: 'fa-list-ul'},
                    {val: 'Deep', title: 'First Principles', desc: 'Deconstruct physics.', icon: 'fa-layer-group'},
                    {val: 'Code', title: 'Code First', desc: 'Show me the code.', icon: 'fa-code'},
                    {val: 'Action', title: 'Action Plans', desc: 'Checklists.', icon: 'fa-check-double'},
                    {val: 'Facts', title: 'Just the Facts', desc: 'No fluff.', icon: 'fa-table'},
                    {val: 'ELI5', title: 'ELI5', desc: 'Simple explanation.', icon: 'fa-shapes'},
                    {val: 'Anxiety', title: 'Low Stress', desc: 'Gentle tone. Reassuring.', icon: 'fa-leaf'},
                    {val: 'NonTech', title: 'Plain English', desc: 'No jargon.', icon: 'fa-comment'}
                ]
            }
        ];

        let auth, db, state = { uid: null };
        let wizIndex = 0, tempWiz = {};
        const getEl = (id) => document.getElementById(id);

        window.app = {
            init: () => {
                firebase.initializeApp(FIREBASE_CONFIG);
                auth = firebase.auth();
                db = firebase.firestore();
                auth.onAuthStateChanged(u => {
                    if(u) { 
                        state.uid = u.uid; 
                        getEl('login-gate').style.display = 'none';
                        getEl('user-email').innerText = u.email; 
                        app.listenData(); 
                        app.handleDeepLink();
                    } else { 
                        getEl('login-gate').style.display = 'flex'; 
                    }
                });
                getEl('wk_memory').addEventListener('change', (e) => { if(state.uid) db.collection('users').doc(state.uid).set({memory: e.target.value}, {merge:true}); });
            },
            login: () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()),
            logout: () => auth.signOut(),
            listenData: () => {
                db.collection('users').doc(state.uid).onSnapshot(doc => {
                    state = { ...state, ...doc.data() };
                    getEl('relay-url').value = state.relayUrl || '';
                    getEl('wk_memory').value = state.memory || '';
                });
            },
            saveKeys: () => { db.collection('users').doc(state.uid).set({ relayUrl: getEl('relay-url').value }, {merge:true}); },
            
            // --- HAPTICS ---
            hapticSuccess: () => { if(navigator.vibrate) navigator.vibrate([50, 30, 50]); },
            hapticTap: () => { if(navigator.vibrate) navigator.vibrate(10); },

            // --- GARDENER ---
            runGardener: async () => {
                const txt = getEl('gardener-input').value.trim();
                const btn = getEl('btn-process');
                const status = getEl('gardener-status');
                if (!txt || !state.relayUrl) { status.innerText = "Error: Missing Text or Relay URL."; return; }
                app.hapticTap();
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Analyzing...';
                status.innerText = "The Gardener is pruning...";
                try {
                    const idToken = await auth.currentUser.getIdToken();
                    cons
